{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞</h2>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="patientTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking" type="button" role="tab">
                ‚ûï –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                üë§ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ
            </button>
        </li>
    </ul>

    <div class="tab-content p-4 border border-top-0 bg-light rounded-bottom" id="patientTabContent">

        <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
        <div class="tab-pane fade show active" id="appointments" role="tabpanel">
            <div id="appointmentsLoader" class="text-center d-none">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover bg-white rounded shadow-sm">
                    <thead class="table-light">
                        <tr>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–í—Ä–∞—á</th>
                            <th>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                    </tbody>
                </table>
            </div>
            <p id="noAppointmentsMsg" class="text-muted text-center d-none">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 2: –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É -->
        <div class="tab-pane fade" id="booking" role="tabpanel">
            <div class="row">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–∏–ª—å—Ç—Ä—ã –∏ –í—Ä–∞—á–∏ -->
                <div class="col-md-4 border-end">
                    <h5 class="mb-3">1. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</h5>

                    <div class="mb-3">
                        <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:</label>
                        <select class="form-select" id="specialtyFilter" onchange="filterDoctors()">
                            <option value="all">–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</option>
                            <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                        </select>
                    </div>
                    <div id="specialtyDescription" class="alert alert-info d-none mb-3" role="alert">
                        <small id="descriptionText"></small>
                    </div>
                    <div class="list-group overflow-auto" style="max-height: 500px;" id="doctorsList">
                        <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="col-md-8">
                    <h5 class="mb-3">2. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h5>
                    <div id="slotsContainer" class="p-3">
                        <div class="alert alert-info">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 3: –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="tab-pane fade" id="profile" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h5>
                            <form id="profileForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">–ò–º—è</label>
                                        <input type="text" id="profFirstName" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                                        <input type="text" id="profLastName" class="form-control" required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                                    <input type="date" id="profDob" class="form-control" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                                    <input type="tel" id="profPhone" class="form-control" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω)</label>
                                    <input type="text" id="profEmergency" class="form-control">
                                </div>

                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                    </button>
                                </div>
                            </form>

                            <hr class="my-4">

                            <h5 class="card-title mb-4">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="oldPassword" class="form-control" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="newPassword" class="form-control" required minlength="8">
                                    <div class="form-text">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" id="newPasswordConfirm" class="form-control" required minlength="8">
                                </div>

                                <div class="text-end">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-key"></i> –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPatientId = null;
    let allDoctors = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/me/')
            .then(r => r.json())
            .then(data => {
                currentPatientId = data.profile_id;
                loadAppointments();
                loadSpecialties();
                loadDoctors();
            });
    });

    // --- –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π ---
    function loadAppointments() {
        const tbody = document.getElementById('appointmentsTableBody');
        const loader = document.getElementById('appointmentsLoader');
        const noMsg = document.getElementById('noAppointmentsMsg');

        tbody.innerHTML = '';
        loader.classList.remove('d-none');
        noMsg.classList.add('d-none');

        fetch(`/api/appointments/`)
            .then(r => r.json())
            .then(appointments => {
                loader.classList.add('d-none');

                const myAppointments = appointments.filter(app => app.patient === currentPatientId);

                if (myAppointments.length === 0) {
                    noMsg.classList.remove('d-none');
                    return;
                }

                myAppointments.forEach(app => {
                    const row = document.createElement('tr');

                    let statusBadge = '<span class="badge bg-secondary">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
                    if (app.status === 'scheduled') statusBadge = '<span class="badge bg-primary">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>';
                    else if (app.status === 'completed') statusBadge = '<span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>';
                    else if (app.status === 'cancelled') statusBadge = '<span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω–æ</span>';

                    let actionBtn = '';
                    if (app.status === 'scheduled') {
                        actionBtn = `<button class="btn btn-outline-danger btn-sm" onclick="cancelAppointment(${app.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
                    }

                    row.innerHTML = `
                        <td>
                            <div class="fw-bold">${app.slot_details.date}</div>
                            <small class="text-muted">${app.slot_details.start_time} - ${app.slot_details.end_time}</small>
                        </td>
                        <td>${app.slot_details.doctor_name}</td>
                        <td>${app.slot_details.doctor_specialty}</td>
                        <td>${statusBadge}</td>
                        <td>${actionBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }

    async function cancelAppointment(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;

        const response = await fetch(`/api/appointments/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (response.ok) {
            loadAppointments();
            const activeDoc = document.querySelector('.list-group-item.active');
            if (activeDoc) activeDoc.click();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏.');
        }
    }

    // --- –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π ---

    // –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –¥–æ–∫—Ç–æ—Ä–æ–≤
    function loadSpecialties() {
        fetch('/api/specialties/')
            .then(r => r.json())
            .then(specialties => {
                const select = document.getElementById('specialtyFilter');
                // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç
                select.innerHTML = '<option value="all">–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</option>';

                specialties.forEach(spec => {
                    const opt = document.createElement('option');
                    opt.value = spec.id;
                    opt.textContent = spec.name;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ data-description –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                    opt.dataset.description = spec.description || '';
                    select.appendChild(opt);
                });

                // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                // select.selectedIndex = 0;
                // filterDoctors();
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π', err);
            });
    }

    // –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–∞–º–∏—Ö –¥–æ–∫—Ç–æ—Ä–æ–≤
    function loadDoctors() {
        fetch('/api/doctors/')
            .then(r => r.json())
            .then(doctors => {
                allDoctors = doctors;
                renderDoctors(doctors);
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π', err);
            });
    }

    // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—Ç–æ—Ä–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    function renderDoctors(doctors) {
        const list = document.getElementById('doctorsList');
        list.innerHTML = '';

        if (doctors.length === 0) {
            list.innerHTML = '<div class="text-muted p-2">–í—Ä–∞—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
            return;
        }

        doctors.forEach(doc => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${doc.user.first_name} ${doc.user.last_name}</h6>
                </div>
                <small class="text-muted">${doc.specialty_details.name}</small>
            `;
            item.onclick = (e) => {
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
                document.querySelectorAll('#doctorsList .list-group-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –≤—Ä–∞—á–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const descDiv = document.getElementById('specialtyDescription');
                const descText = document.getElementById('descriptionText');
                const s = doc.specialty_details && doc.specialty_details.description ? doc.specialty_details.description : '';
                if (s && s.trim()) {
                    descText.innerText = s;
                    descDiv.classList.remove('d-none');
                } else {
                    // –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                    descText.innerText = '';
                    descDiv.classList.add('d-none');
                }

                loadSlots(doc.id, doc.user.last_name);
            };
            list.appendChild(item);
        });
    }

    // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—Ç–æ—Ä–æ–≤ –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
    function filterDoctors() {
        const select = document.getElementById('specialtyFilter');
        const specId = select.value;
        const descDiv = document.getElementById('specialtyDescription');
        const descText = document.getElementById('descriptionText');

        if (specId === 'all') {
            renderDoctors(allDoctors);
            descText.innerText = '';
            descDiv.classList.add('d-none');
            return;
        }

        const selectedOption = select.options[select.selectedIndex];
        const description = selectedOption?.dataset?.description || '';

        if (description.trim()) {
            descText.innerText = description;
            descDiv.classList.remove('d-none');
        } else {
            descText.innerText = '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.';
            descDiv.classList.remove('d-none');
        }

        const filtered = allDoctors.filter(d => String(d.specialty_details.id) === String(specId));
        renderDoctors(filtered);
    }

    function loadSlots(doctorId, doctorName) {
        const container = document.getElementById('slotsContainer');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';

        fetch(`/api/slots/?doctor=${doctorId}&status=free`)
            .then(r => r.json())
            .then(slots => {
                container.innerHTML = '';
                if (slots.length === 0) {
                    container.innerHTML = `<div class="alert alert-warning">–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—Ç–æ—Ä–∞ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.</div>`;
                    return;
                }

                const slotsByDate = {};
                slots.forEach(slot => {
                    if (!slotsByDate[slot.date]) slotsByDate[slot.date] = [];
                    slotsByDate[slot.date].push(slot);
                });

                for (const [date, daySlots] of Object.entries(slotsByDate)) {
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'mb-4';
                    dateGroup.innerHTML = `<h6 class="border-bottom pb-2 mb-3 text-primary">${formatDate(date)}</h6>`;

                    const row = document.createElement('div');
                    row.className = 'd-flex flex-wrap gap-2';

                    daySlots.sort((a, b) => a.start_time.localeCompare(b.start_time));

                    daySlots.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-success btn-sm';
                        btn.style.minWidth = '80px';
                        const timeShort = slot.start_time.substring(0, 5);
                        btn.innerText = timeShort;
                        btn.onclick = () => bookSlot(slot.id, date, timeShort);
                        row.appendChild(btn);
                    });

                    dateGroup.appendChild(row);
                    container.appendChild(dateGroup);
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤', err);
                container.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—Ç–æ–≤.</div>`;
            });
    }

    async function bookSlot(slotId, date, time) {
        if (!confirm(`–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${date} –≤ ${time}?`)) return;

        const response = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                patient: currentPatientId,
                slot: slotId
            })
        });

        if (response.ok) {
            alert('–£—Å–ø–µ—à–Ω–æ! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã.');
            const tabTrigger = new bootstrap.Tab(document.querySelector('#appointments-tab'));
            tabTrigger.show();
            loadAppointments();
            document.getElementById('slotsContainer').innerHTML = '<div class="alert alert-success">–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.</div>';
            document.querySelectorAll('#doctorsList .list-group-item').forEach(el => el.classList.remove('active'));
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏. –í–æ–∑–º–æ–∂–Ω–æ, —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç.');
            const activeDoc = document.querySelector('.list-group-item.active');
            if (activeDoc) activeDoc.click();
        }
    }

    function formatDate(dateString) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('ru-RU', options);
    }

    document.getElementById('profile-tab').addEventListener('shown.bs.tab', () => {
        loadProfileData();
    });

    function loadProfileData() {
        if (!currentPatientId) return;

        fetch(`/api/patients/${currentPatientId}/`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('profFirstName').value = data.user.first_name;
                document.getElementById('profLastName').value = data.user.last_name;
                document.getElementById('profDob').value = data.date_of_birth;
                document.getElementById('profPhone').value = data.phone_number;
                document.getElementById('profEmergency').value = data.emergency_contact;
            })
            .catch(err => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è'));
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentPatientId) return;

        const payload = {
            user: {
                first_name: document.getElementById('profFirstName').value,
                last_name: document.getElementById('profLastName').value,
            },
            date_of_birth: document.getElementById('profDob').value,
            phone_number: document.getElementById('profPhone').value,
            emergency_contact: document.getElementById('profEmergency').value
        };

        try {
            const res = await fetch(`/api/patients/${currentPatientId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            } else {
                const err = await res.json();
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + JSON.stringify(err));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

        if (newPassword !== newPasswordConfirm) {
            alert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }

        try {
            const res = await fetch('/api/change-password/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword,
                    new_password_confirm: newPasswordConfirm
                })
            });

            const data = await res.json();

            if (res.ok) {
                alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
                document.getElementById('changePasswordForm').reset();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    });
</script>
{% endblock %}