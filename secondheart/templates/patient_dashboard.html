{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞</h2>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
    <ul class="nav nav-tabs" id="patientTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                üìÖ –ú–æ–∏ –∑–∞–ø–∏—Å–∏
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="booking-tab" data-bs-toggle="tab" data-bs-target="#booking" type="button" role="tab">
                ‚ûï –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º
            </button>
        </li>
    </ul>

    <div class="tab-content p-4 border border-top-0 bg-light rounded-bottom" id="patientTabContent">

        <!-- –í–∫–ª–∞–¥–∫–∞ 1: –ú–æ–∏ –∑–∞–ø–∏—Å–∏ -->
        <div class="tab-pane fade show active" id="appointments" role="tabpanel">
            <div id="appointmentsLoader" class="text-center d-none">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover bg-white rounded shadow-sm">
                    <thead class="table-light">
                        <tr>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–í—Ä–∞—á</th>
                            <th>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                    </tbody>
                </table>
            </div>
            <p id="noAppointmentsMsg" class="text-muted text-center d-none">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ 2: –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É -->
        <div class="tab-pane fade" id="booking" role="tabpanel">
            <div class="row">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–∏–ª—å—Ç—Ä—ã –∏ –í—Ä–∞—á–∏ -->
                <div class="col-md-4 border-end">
                    <h5 class="mb-3">1. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</h5>

                    <div class="mb-3">
                        <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:</label>
                        <select class="form-select" id="specialtyFilter" onchange="filterDoctors()">
                            <option value="all">–í—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</option>
                            <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                        </select>
                    </div>

                    <div class="list-group overflow-auto" style="max-height: 500px;" id="doctorsList">
                        <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —ç—Ç–æ -->
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="col-md-8">
                    <h5 class="mb-3">2. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h5>
                    <div id="slotsContainer" class="p-3">
                        <div class="alert alert-info">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPatientId = null;
    let allDoctors = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/me/')
            .then(r => r.json())
            .then(data => {
                currentPatientId = data.profile_id;
                loadAppointments();
                loadSpecialties();
                loadDoctors();
            });
    });

    // --- –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π ---

    // –ø–æ–¥–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π
    function loadAppointments() {
        const tbody = document.getElementById('appointmentsTableBody');
        const loader = document.getElementById('appointmentsLoader');
        const noMsg = document.getElementById('noAppointmentsMsg');

        tbody.innerHTML = '';
        loader.classList.remove('d-none');
        noMsg.classList.add('d-none');

        fetch(`/api/appointments/`)
            .then(r => r.json())
            .then(appointments => {
                loader.classList.add('d-none');

                // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ id –ø–∞—Ü–∏–µ–Ω—Ç–∞
                const myAppointments = appointments.filter(app => app.patient === currentPatientId);

                if (myAppointments.length === 0) {
                    noMsg.classList.remove('d-none');
                    return;
                }

                myAppointments.forEach(app => {
                    const row = document.createElement('tr');

                    // —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏
                    let statusBadge = '<span class="badge bg-secondary">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
                    if (app.status === 'scheduled') statusBadge = '<span class="badge bg-primary">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>';
                    else if (app.status === 'completed') statusBadge = '<span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>';
                    else if (app.status === 'cancelled') statusBadge = '<span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω–æ</span>';

                    // —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
                    let actionBtn = '';
                    if (app.status === 'scheduled') {
                        actionBtn = `<button class="btn btn-outline-danger btn-sm" onclick="cancelAppointment(${app.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>`;
                    }

                    row.innerHTML = `
                        <td>
                            <div class="fw-bold">${app.slot_details.date}</div>
                            <small class="text-muted">${app.slot_details.start_time} - ${app.slot_details.end_time}</small>
                        </td>
                        <td>${app.slot_details.doctor_name}</td>
                        <td>${app.slot_details.doctor_specialty}</td>
                        <td>${statusBadge}</td>
                        <td>${actionBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }

    // —É–¥–∞–ª–µ–∏–µ –∑–∞–ø–∏—Å–∏
    async function cancelAppointment(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;

        const response = await fetch(`/api/appointments/${id}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (response.ok) {
            loadAppointments();
            const activeDoc = document.querySelector('.list-group-item.active');
            if (activeDoc) activeDoc.click();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏.');
        }
    }

    // --- –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π ---

    // –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –¥–æ–∫—Ç–æ—Ä–æ–≤
    function loadSpecialties() {
        fetch('/api/specialties/')
            .then(r => r.json())
            .then(specialties => {
                const select = document.getElementById('specialtyFilter');
                specialties.forEach(spec => {
                    const opt = document.createElement('option');
                    opt.value = spec.id;
                    opt.innerText = spec.name;
                    select.appendChild(opt);
                });
            });
    }

    // –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–∞–º–∏—Ö –¥–æ–∫—Ç–æ—Ä–æ–≤
    function loadDoctors() {
        fetch('/api/doctors/')
            .then(r => r.json())
            .then(doctors => {
                allDoctors = doctors;
                renderDoctors(doctors);
            });
    }

    // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—Ç–æ—Ä–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    function renderDoctors(doctors) {
        const list = document.getElementById('doctorsList');
        list.innerHTML = '';

        if (doctors.length === 0) {
            list.innerHTML = '<div class="text-muted p-2">–í—Ä–∞—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
            return;
        }

        doctors.forEach(doc => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${doc.user.first_name} ${doc.user.last_name}</h6>
                </div>
                <small class="text-muted">${doc.specialty_details.name}</small>
            `;
            item.onclick = (e) => {
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
                document.querySelectorAll('#doctorsList .list-group-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                loadSlots(doc.id, doc.user.last_name);
            };
            list.appendChild(item);
        });
    }

    // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—Ç–æ—Ä–æ–≤ –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
    function filterDoctors() {
        const specId = document.getElementById('specialtyFilter').value;
        if (specId === 'all') {
            renderDoctors(allDoctors);
        } else {
            const filtered = allDoctors.filter(d => d.specialty_details.id == specId);
            renderDoctors(filtered);
        }
    }

    function loadSlots(doctorId, doctorName) {
        const container = document.getElementById('slotsContainer');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';

        fetch(`/api/slots/?doctor=${doctorId}&status=free`)
            .then(r => r.json())
            .then(slots => {
                container.innerHTML = '';
                if (slots.length === 0) {
                    container.innerHTML = `<div class="alert alert-warning">–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—Ç–æ—Ä–∞ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.</div>`;
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ
                const slotsByDate = {};
                slots.forEach(slot => {
                    if (!slotsByDate[slot.date]) slotsByDate[slot.date] = [];
                    slotsByDate[slot.date].push(slot);
                });

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º
                for (const [date, daySlots] of Object.entries(slotsByDate)) {
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'mb-4';
                    dateGroup.innerHTML = `<h6 class="border-bottom pb-2 mb-3 text-primary">${formatDate(date)}</h6>`;

                    const row = document.createElement('div');
                    row.className = 'd-flex flex-wrap gap-2';

                    daySlots.sort((a, b) => a.start_time.localeCompare(b.start_time)); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

                    daySlots.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-success btn-sm';
                        btn.style.minWidth = '80px';
                        // –û–±—Ä–µ–∑–∞–µ–º —Å–µ–∫—É–Ω–¥—ã –∏–∑ –≤—Ä–µ–º–µ–Ω–∏ (HH:MM:SS -> HH:MM)
                        const timeShort = slot.start_time.substring(0, 5);
                        btn.innerText = timeShort;
                        btn.onclick = () => bookSlot(slot.id, date, timeShort);
                        row.appendChild(btn);
                    });

                    dateGroup.appendChild(row);
                    container.appendChild(dateGroup);
                }
            });
    }

    async function bookSlot(slotId, date, time) {
        if (!confirm(`–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${date} –≤ ${time}?`)) return;

        const response = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                patient: currentPatientId,
                slot: slotId
            })
        });

        if (response.ok) {
            alert('–£—Å–ø–µ—à–Ω–æ! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã.');
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ú–æ–∏ –∑–∞–ø–∏—Å–∏"
            const tabTrigger = new bootstrap.Tab(document.querySelector('#appointments-tab'));
            tabTrigger.show();
            loadAppointments(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π

            // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–æ—Ç–æ–≤
            document.getElementById('slotsContainer').innerHTML = '<div class="alert alert-success">–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.</div>';
            document.querySelectorAll('#doctorsList .list-group-item').forEach(el => el.classList.remove('active'));
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏. –í–æ–∑–º–æ–∂–Ω–æ, —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç.');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–∞—á–∞, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∑–∞–Ω—è—Ç—ã–π
            const activeDoc = document.querySelector('.list-group-item.active');
            if (activeDoc) activeDoc.click();
        }
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(dateString) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('ru-RU', options);
    }
</script>
{% endblock %}